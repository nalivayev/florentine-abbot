[![en](https://img.shields.io/badge/lang-en-red.svg)](https://github.com/nalivayev/florentine_abbot/blob/master/README.md)
[![ru](https://img.shields.io/badge/lang-ru-yellow.svg)](https://github.com/nalivayev/florentine_abbot/blob/master/README.ru.md)

# Florentine Abbot

Утилита для автоматизации и оптимизации процесса сканирования с помощью [VueScan](https://www.hamrick.com) от Ed Hamrick.

## Возможности

- **Автоматический расчёт оптимального DPI сканирования** на основе параметров фотографии и требований к результату.
- **Пакетная обработка**: интерактивный режим, одиночный расчёт или обработка папки.
- **Гибкая система шаблонов** для имён файлов и метаданных, включая извлечение EXIF.
- **Автоматизация рабочего процесса**: запуск VueScan с сгенерированными настройками, перемещение и переименование файлов, извлечение EXIF-метаданных.
- **Подробное логирование** всех этапов работы.
- **Командная строка** с валидацией аргументов и справкой.
- **Плагинная система**: легко расширяйте рабочие процессы, добавляя новые плагины (см. ниже).

## Основные модули

- `scan_batcher/cli.py` — основной CLI-модуль (используется для команды `scan-batcher`).
- `scan_batcher/batch.py` — логика пакетных и интерактивных расчётов DPI.
- `scan_batcher/calculator.py` — алгоритмы расчёта DPI.
- `scan_batcher/parser.py` — парсинг и валидация аргументов командной строки.
- `scan_batcher/recorder.py` — модуль логирования.
- `scan_batcher/constants.py` — централизованные константы и перечисления (например, `RoundingStrategy`).
- `scan_batcher/workflow.py` — базовый класс для всех workflow-плагинов.
- `scan_batcher/workflows/__init__.py` — регистрация и обнаружение плагинов.
- `scan_batcher/workflows/vuescan/workflow.py` — автоматизация рабочего процесса VueScan.
- `scan_batcher/exifer.py` — извлечение и обработка EXIF-метаданных.

## Система шаблонов

Шаблоны используются в настройках и именах файлов для подстановки динамических значений.

**Формат шаблона:**

```
{<name>[:length[:align[:pad]]]}
```

- `name` — имя переменной шаблона  
- `length` — итоговая длина (необязательно)  
- `align` — выравнивание (`<`, `>`, `^`; необязательно)  
- `pad` — символ заполнения (необязательно)  

## Поддерживаемые переменные шаблонов

- `user_name` — имя пользователя операционной системы  
- `digitization_year` — год оцифровки (из EXIF или времени изменения файла)  
- `digitization_month` — месяц оцифровки  
- `digitization_day` — день оцифровки  
- `digitization_hour` — час оцифровки  
- `digitization_minute` — минута оцифровки  
- `digitization_second` — секунда оцифровки  
- `scan_dpi` — значение DPI, выбранное или рассчитанное в ходе пакетной или интерактивной обработки  
- ...а также любые дополнительные переменные, переданные через командную строку (`--templates ключ=значение`) или batch-шаблоны

**Примечание:**  
Если EXIF-метаданные отсутствуют, переменные даты и времени заполняются временем изменения файла.

**Пример:**
```
{digitization_year:8:>:0}
```

## Использование

Запуск основного рабочего процесса:

```sh
scan-batcher --workflow <путь_к_ini> --engine vuescan --batch scan --min-dpi 300 --max-dpi 4800 --dpis 600 1200 2400 4800
```

Программа **интерактивно запросит** у вас размеры фотографии и изображения во время выполнения.

Для получения полного списка аргументов и опций используйте:

```sh
scan-batcher --help
```

## Аргументы командной строки

### Доступные аргументы
- `-b, --batch` - Режим пакетной обработки: scan (интерактивный), calculate (одиночный расчёт), или process (обработка папки). По умолчанию: scan
- `-w, --workflow` - Путь к файлу конфигурации рабочего процесса (формат INI) для пакетной обработки
- `-t, --templates` - Список пар ключ-значение для шаблонов имён файлов или метаданных, например `-t year=2024 author=Smith`
- `-e, --engine` - Движок сканирования для обработки (по умолчанию: vuescan)
- `-mnd, --min-dpi` - Минимально допустимое значение DPI для сканирования (необязательно)
- `-mxd, --max-dpi` - Максимально допустимое значение DPI для сканирования (необязательно)
- `-d, --dpis` - Список поддерживаемых сканером разрешений DPI, разделённых пробелом, например `100 300 1200`
- `-r, --rounding` - Стратегия округления: `mx` (максимальное), `mn` (минимальное), `nr` (ближайшее). По умолчанию: nr. Внутри использует enum `RoundingStrategy`

## Примеры использования

### Интерактивный расчёт DPI (режим scan)
```sh
scan-batcher --workflow examples/workflow.ini --batch scan --dpis 300 600 1200 2400
```
*Программа запросит у вас размеры фотографии в интерактивном режиме.*

### Одиночный расчёт DPI (режим calculate)
```sh
scan-batcher --workflow examples/workflow.ini --batch calculate --min-dpi 300 --max-dpi 4800 --dpis 600 1200 2400 4800 --rounding nr
```
*Программа запросит размеры фотографии и изображения, затем завершится после одного расчёта.*

### Обработка файлов из папки
```sh
scan-batcher --workflow examples/workflow.ini --batch process /path/to/scanned/files --templates author="John Doe" project="Family Archive"
```
*Обработка существующих файлов без интерактивного ввода.*

## Логирование

Все этапы работы и ошибки логируются в файл с тем же именем, что и скрипт, и расширением `.log`.

## Установка

### Требования
- Python 3.8 или выше
- Программа VueScan (для операций сканирования)

### Установка из исходного кода

Для локальной установки пакета из исходного каталога используйте:

```sh
pip install .
```

Это установит все необходимые зависимости и сделает команду `scan-batcher` доступной в вашей системе.

> **Примечание:**  
> Рекомендуется использовать [виртуальное окружение](https://docs.python.org/3/library/venv.html) для установки и разработки.

### Установка для разработки

Для разработки с редактируемой установкой:

```sh
pip install -e .
```

Для обновления уже установленного пакета используйте:

```sh
pip install --upgrade .
```

## Документация

- Индекс документации: [docs/README.ru.md](docs/README.ru.md)
- Руководство по именованию (RU): [docs/ru/naming.md](docs/ru/naming.md)

---

Для подробностей см. [README.md](README.md) (на английском).
