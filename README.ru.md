[![en](https://img.shields.io/badge/lang-en-red.svg)](https://github.com/nalivayev/florentine_abbot/blob/master/README.md)
[![ru](https://img.shields.io/badge/lang-ru-yellow.svg)](https://github.com/nalivayev/florentine_abbot/blob/master/README.ru.md)

# Florentine Abbot

Florentine Abbot — это проект, посвященный сканированию и цифровой организации домашних фотоархивов.

> **⚠️ Статус проекта**: В настоящее время упакована и готова к использованию только утилита **Scan Batcher**. Дополнительные модули (`file_organizer`, `archive_keeper`) находятся в разработке и пока не полностью протестированы или документированы.

## Сканирование (Scan Batcher)

Утилита для автоматизации и оптимизации процесса сканирования с помощью [VueScan](https://www.hamrick.com) от Ed Hamrick.

### Зачем это нужно?

VueScan — мощный инструмент, но при потоковом сканировании его гибкость превращается в проблему: сотни настроек на разных вкладках легко случайно изменить или забыть выставить.

Florentine Abbot решает это за счёт эталонных INI‑профилей и автоматизированного процесса, что даёт:
- **Предсказуемость** — одинаковые настройки для каждого скана
- **Воспроизводимость** — точный повтор процесса даже спустя время
- **Стандартизацию** — единый рабочий процесс для команды
- **Автоматизацию** — меньше ручных действий и ниже риск ошибок

### Возможности

- **Автоматический расчёт оптимального DPI сканирования** на основе параметров фотографии и требований к результату.
- **Пакетная обработка**: интерактивный режим, одиночный расчёт или обработка папки.
- **Гибкая система шаблонов** для имён файлов и метаданных, включая извлечение EXIF.
- **Автоматизация рабочего процесса**: запуск VueScan с сгенерированными настройками, перемещение и переименование файлов, извлечение EXIF-метаданных.
- **Подробное логирование** всех этапов работы.
- **Командная строка** с валидацией аргументов и справкой.
- **Плагинная система**: легко расширяйте рабочие процессы, добавляя новые плагины.

### Требования

- Python 3.10+
- [ExifTool](https://exiftool.org/) должен быть установлен и доступен в PATH.

### Использование

Запуск основного рабочего процесса:

```sh
scan-batcher --workflow <путь_к_ini> --engine vuescan --batch scan --min-dpi 300 --max-dpi 4800 --dpis 600 1200 2400 4800
```

Программа **интерактивно запросит** у вас размеры фотографии и изображения во время выполнения.

В Windows PowerShell синтаксис тот же. Если значения содержат пробелы — используйте кавычки:

```powershell
scan-batcher --workflow .\examples\workflow.ini --batch scan --dpis 300 600 1200 2400 --templates author="John Doe" project="Family Archive"
```

Для получения полного списка аргументов и опций используйте:

```sh
scan-batcher --help
```

#### Аргументы командной строки

- `-b, --batch` - Режим пакетной обработки: scan (интерактивный), calculate (одиночный расчёт), или process (обработка папки). По умолчанию: scan
- `-w, --workflow` - Путь к файлу конфигурации рабочего процесса (формат INI) для пакетной обработки
- `-t, --templates` - Список пар ключ-значение для шаблонов имён файлов или метаданных, например `-t year=2024 author=Smith`
- `-e, --engine` - Движок сканирования для обработки (по умолчанию: vuescan)
- `-mnd, --min-dpi` - Минимально допустимое значение DPI для сканирования (необязательно)
- `-mxd, --max-dpi` - Максимально допустимое значение DPI для сканирования (необязательно)
- `-d, --dpis` - Список поддерживаемых сканером разрешений DPI, разделённых пробелом, например `100 300 1200`
- `-r, --rounding` - Стратегия округления: `mx` (максимальное), `mn` (минимальное), `nr` (ближайшее). По умолчанию: nr. Внутри использует enum `RoundingStrategy`

#### Примеры использования

**Интерактивный расчёт DPI (режим scan)**
```sh
scan-batcher --workflow examples/workflow.ini --batch scan --dpis 300 600 1200 2400
```
*Программа запросит у вас размеры фотографии в интерактивном режиме.*

**Одиночный расчёт DPI (режим calculate)**
```sh
scan-batcher --workflow examples/workflow.ini --batch calculate --min-dpi 300 --max-dpi 4800 --dpis 600 1200 2400 4800 --rounding nr
```
*Программа запросит размеры фотографии и изображения, затем завершится после одного расчёта.*

**Обработка файлов из папки**
```sh
scan-batcher --workflow examples/workflow.ini --batch process /path/to/scanned/files --templates author="John Doe" project="Family Archive"
```
*Обработка существующих файлов без интерактивного ввода.*

### Система шаблонов

Шаблоны используются в настройках и именах файлов для подстановки динамических значений.

**Формат шаблона:**

```
{<name>[:length[:align[:pad]]]}
```

- `name` — имя переменной шаблона  
- `length` — итоговая длина (необязательно)  
- `align` — выравнивание (`<`, `>`, `^`; необязательно)  
- `pad` — символ заполнения (необязательно)  

#### Поддерживаемые переменные шаблонов

- `user_name` — имя пользователя операционной системы  
- `digitization_year` — год оцифровки (из EXIF или времени изменения файла)  
- `digitization_month` — месяц оцифровки  
- `digitization_day` — день оцифровки  
- `digitization_hour` — час оцифровки  
- `digitization_minute` — минута оцифровки  
- `digitization_second` — секунда оцифровки  
- `scan_dpi` — значение DPI, выбранное или рассчитанное в ходе пакетной или интерактивной обработки  
- ...а также любые дополнительные переменные, переданные через командную строку (`--templates ключ=значение`) или batch-шаблоны

**Примечание:**  
Если EXIF-метаданные отсутствуют, переменные даты и времени заполняются временем изменения файла.

**Пример:**
```
{digitization_year:8:>:0}
```

## Автоматическая организация (Archive Organizer)

Инструмент для автоматической организации отсканированных файлов на основе их имен. Он извлекает метаданные из имени файла (дата, модификаторы) и перемещает файл в структурированную иерархию папок (`YYYY.M/YYYY.MM.DD.M/SUFFIX`). Также он записывает эти метаданные в теги EXIF/XMP файла.

### Использование

**Пакетный режим (обработка существующих файлов):**
```sh
archive-organizer "D:\Scans\Inbox"
```

**Режим наблюдения (демон):**
```sh
archive-organizer "D:\Scans\Inbox" --watch
```

**С метаданными:**
```sh
archive-organizer "D:\Scans\Inbox" --creator "Иван Иванов" --rights "Все права защищены"
```

## Целостность архива (Archive Keeper)

Инструмент для обеспечения долгосрочной целостности вашего цифрового архива. Он сканирует папку архива, вычисляет хеши SHA-256 всех файлов и сохраняет их в базе данных SQLite. При последующих запусках он обнаруживает:
- **Новые файлы** (Added)
- **Измененные файлы** (Content changed)
- **Перемещенные файлы** (Same content, different path)
- **Пропавшие файлы** (Deleted or moved outside)
- **Поврежденные файлы** (Bit rot detection)

### Использование

```sh
archive-keeper "D:\Archive\Photos"
```

Это создаст файл `archive.db` и заполнит его текущим состоянием архива. Последующие запуски будут сравнивать файловую систему с этой базой данных.

## Технические детали

### Основные модули

- `scan_batcher/cli.py` — основной CLI-модуль (используется для команды `scan-batcher`).
- `archive_keeper/cli.py` — CLI для утилиты `archive-keeper`.
- `file_organizer/cli.py` — CLI для утилиты `archive-organizer`.
- `scan_batcher/batch.py` — логика пакетных и интерактивных расчётов DPI.
- `scan_batcher/calculator.py` — алгоритмы расчёта DPI.
- `scan_batcher/parser.py` — парсинг и валидация аргументов командной строки.
- `scan_batcher/recorder.py` — модуль логирования.
- `scan_batcher/constants.py` — централизованные константы и перечисления (например, `RoundingStrategy`).
- `scan_batcher/workflow.py` — базовый класс для всех workflow-плагинов.
- `scan_batcher/workflows/__init__.py` — регистрация и обнаружение плагинов.
- `scan_batcher/workflows/vuescan/workflow.py` — автоматизация рабочего процесса VueScan.
- `scan_batcher/exifer.py` — извлечение и обработка EXIF-метаданных.

### Установка

#### Требования
- Python 3.10 или выше
- Программа VueScan (для операций сканирования)

#### Установка из исходного кода

Для локальной установки пакета из исходного каталога используйте:

```sh
pip install .
```

Это установит все необходимые зависимости и сделает команду `scan-batcher` доступной в вашей системе.

> **Примечание:**  
> Рекомендуется использовать [виртуальное окружение](https://docs.python.org/3/library/venv.html) для установки и разработки.

#### Установка для разработки

Для разработки с редактируемой установкой:

```sh
pip install -e .
```

Для обновления уже установленного пакета используйте:

```sh
pip install --upgrade .
```

### Логирование

Все этапы работы и ошибки логируются в файл с тем же именем, что и скрипт, и расширением `.log`.

## Документация

- Индекс документации: [docs/README.ru.md](docs/README.ru.md)
- Руководство по именованию (RU): [docs/ru/naming.md](docs/ru/naming.md)

---

Для подробностей см. [README.md](README.md) (на английском).
